services:
    # Frontend Application
    monochrome:
        image: ghcr.io/r0m1k3/monoflow:latest
        container_name: monochrome-app
        restart: unless-stopped
        ports:
            - '${MONOCHROME_PORT:-3001}:4173'
        environment:
            - POCKETBASE_URL=${POCKETBASE_URL:-http://pocketbase:8090}
            - PUBLIC_POCKETBASE_URL=${PUBLIC_POCKETBASE_URL:-} # URL visible from browser
            - REDIS_URL=redis://redis:6379
            - S3_ENDPOINT=http://minio:9000
            - S3_BUCKET=${MINIO_BUCKET_NAME:-monochrome-music}
            - S3_ACCESS_KEY=${MINIO_ROOT_USER:-monochrome}
            - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-monochrome_secret}
            - BODY_SIZE_LIMIT=${BODY_SIZE_LIMIT:-0} # 0 = unlimited
            - ORIGIN=${ORIGIN:-*}
        depends_on:
            - pocketbase
            - redis
            - minio-init
        networks:
            - monochrome_net

    # Backend / Database
    pocketbase:
        image: ghcr.io/muchobien/pocketbase:latest
        container_name: monochrome-pb
        restart: unless-stopped
        ports:
            - '${POCKETBASE_PORT:-8091}:8090'
        volumes:
            - ${HOST_DATA_PATH:-./data}/pb_data:/pb_data
            - ${HOST_DATA_PATH:-./data}/pb_public:/pb_public
            - ${HOST_DATA_PATH:-./data}/pb_hooks:/pb_hooks
        environment:
            - PB_ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
            - PB_ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
        healthcheck:
            test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8090/api/health']
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - monochrome_net

    # S3 Compatible Storage
    minio:
        image: minio/minio
        container_name: monochrome-s3
        restart: unless-stopped
        command: server /data --console-address ":9001"
        ports:
            - '${MINIO_API_PORT:-9000}:9000'
            - '${MINIO_CONSOLE_PORT:-9001}:9001'
        environment:
            - MINIO_ROOT_USER=${MINIO_ROOT_USER:-monochrome}
            - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-monochrome_secret}
        volumes:
            - ${HOST_DATA_PATH:-./data}/minio_data:/data
        networks:
            - monochrome_net

    # MinIO bucket initializer (runs once at startup)
    minio-init:
        image: minio/mc
        container_name: monochrome-s3-init
        depends_on:
            - minio
        entrypoint: >
            /bin/sh -c " sleep 5; mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-monochrome} ${MINIO_ROOT_PASSWORD:-monochrome_secret}; mc mb --ignore-existing local/${MINIO_BUCKET_NAME:-monochrome-music}; mc anonymous set download local/${MINIO_BUCKET_NAME:-monochrome-music}; echo 'Bucket ready.'; "
        networks:
            - monochrome_net

    # Cache & Session Store
    redis:
        image: redis:alpine
        container_name: monochrome-redis
        restart: unless-stopped
        volumes:
            - ${HOST_DATA_PATH:-./data}/redis_data:/data
        networks:
            - monochrome_net

networks:
    monochrome_net:
        driver: bridge
